{% extends "base.html" %}

{% block content %}

{% include 'sidebar.html' %}

<div class="flex-1 bg-white p-8">
    {% include 'navbar.html' %}
    <div class="flex justify-between my-4">
        <h1 class="text-2xl font-bold text-gray-900">Task Manager</h1>
        <a href="{% url 'task_create' %}" class="bg-blue-500 text-white px-4 py-2 rounded">Create Task</a>
    </div>
    <div class="grid grid-cols-3 gap-4">
        <div id="in_progress" class="p-4 rounded">
            <div class="flex justify-between rounded border border-100 border-purple-600 px-2 mb-2">
                <h3 class="text-xl mb-2 font-semibold text-gray-900">In Progress</h3>
                <button type="button" class="inline-flex justify-center rounded-md shadow-sm py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none dropdown-toggle">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M6 10a2 2 0 114-0 2 2 0 01-4 0zM6 15a2 2 0 114-0 2 2 0 01-4 0zM6 5a2 2 0 114-0 2 2 0 01-4 0z"/>
                    </svg>
                </button>
            </div>
            <div id="in_progress_tasks"></div>
        </div>
        <div id="completed" class="p-4 rounded">
            <div class="flex justify-between rounded border border-100 border-purple-600 px-2 mb-2">
                <h3 class="text-xl mb-2 font-semibold text-gray-900">Completed Task</h3>
                <button type="button" class="inline-flex justify-center rounded-md shadow-sm py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none dropdown-toggle">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M6 10a2 2 0 114-0 2 2 0 01-4 0zM6 15a2 2 0 114-0 2 2 0 01-4 0zM6 5a2 2 0 114-0 2 2 0 01-4 0z"/>
                    </svg>
                </button>
            </div>
            <div id="completed_tasks"></div>
        </div>
        <div id="overdue" class="p-4 rounded">
            <div class="flex justify-between rounded border border-100 border-purple-600 px-2 mb-2">
                <h3 class="text-xl mb-2 font-semibold text-gray-900">Over-Due</h3>
                <button type="button" class="inline-flex justify-center rounded-md shadow-sm py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none dropdown-toggle">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M6 10a2 2 0 114-0 2 2 0 01-4 0zM6 15a2 2 0 114-0 2 2 0 01-4 0zM6 5a2 2 0 114-0 2 2 0 01-4 0z"/>
                    </svg>
                </button>
            </div>
            <div id="overdue_tasks"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    function formatDueDate(dateTimeStr) {
        const dueDate = new Date(dateTimeStr);
        const currentDate = new Date();

        // Check if the due date is today
        if (dueDate.toDateString() === currentDate.toDateString()) {
            return dueDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        }

        // Check if the due date is tomorrow
        const tomorrow = new Date(currentDate);
        tomorrow.setDate(currentDate.getDate() + 1);
        if (dueDate.toDateString() === tomorrow.toDateString()) {
            return 'Tomorrow';
        }

        // For other dates, format as '16/04/24'
        const formattedDate = dueDate.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\//g, '-');
        return formattedDate;
    }

    function loadTasks(status, container) {
        $.ajax({
            url: "{% url 'api_tasks' %}",
            data: {status: status},
            success: function(data) {
                var html = '';
                data.forEach(function(task) {
                    var dueDateFormatted = formatDueDate(task.due_date);

                    html += `
                        <div class="flex justify-between items-center py-2">
                            <div class="flex space-x-4 justify-between items-center">
                                <span class="bg-red-300 text-gray-700 px-3 py-2 rounded text-xs font-semibold">${task.priority}</span>
                                <span class="bg-white shadow-md text-purple-400 px-3 py-2 rounded text-xs font-semibold flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m5-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    ${dueDateFormatted}
                                </span>
                                <span class="bg-purple-100 text-purple-600 px-3 py-2 rounded text-xs font-semibold">${task.category}</span>
                            </div>    
                        </div>
                        <div class="task py-3 px-4 mb-2 rounded shadow-md bg-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg text-gray-800 font-semibold">${task.title}</h3>
                                <div class="relative inline-block text-left">
                                    <button type="button" class="inline-flex justify-center w-full rounded-md px-2 py-2 text-sm font-medium text-gray-700 focus:outline-none dropdown-toggle" id="options-menu-${task.id}" aria-expanded="true" aria-haspopup="true">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M6 10a2 2 0 114-0 2 2 0 01-4 0zM6 15a2 2 0 114-0 2 2 0 01-4 0zM6 5a2 2 0 114-0 2 2 0 01-4 0z"/>
                                        </svg>
                                    </button>
                                    <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu hidden" role="menu" aria-orientation="vertical" aria-labelledby="options-menu-${task.id}">
                                        <div class="py-1" role="none">
                                            <a href="/tasks/task/${task.id}/edit/" class="text-gray-700 block px-4 py-2 text-sm" role="menuitem">Edit</a>
                                            <form method="post" action="/tasks/task/${task.id}/delete/" role="menuitem">
                                                {% csrf_token %}
                                                <button type="submit" class="text-gray-700 block w-full text-left px-4 py-2 text-sm">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="truncate text-gray-600">${task.description}</p>
                            <div class="flex justify-start my-2">
                                <div class="flex justify-between rounded border border-lg px-1 border-gray-400">
                                    <span class="text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-list" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <line x1="9" y1="6" x2="20" y2="6" />
                                            <line x1="9" y1="12" x2="20" y2="12" />
                                            <line x1="9" y1="18" x2="20" y2="18" />
                                            <line x1="5" y1="6" x2="5" y2="6.01" />
                                            <line x1="5" y1="12" x2="5" y2="12.01" />
                                            <line x1="5" y1="18" x2="5" y2="18.01" />
                                        </svg>
                                    </span>
                                    <span class="text-gray-400">0/3</span>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <div class="flex justify-between mt-2">
                                    <div class="flex space-x-2 items-center">
                                        <img src="https://via.placeholder.com/20" class="rounded-full w-5 h-5" alt="User 1">
                                        <img src="https://via.placeholder.com/20" class="rounded-full w-5 h-5 -ml-4 -z-10" alt="User 2">
                                        <img src="https://via.placeholder.com/20" class="rounded-full w-5 h-5 -mr-5 -z-20" alt="User 3">
                                        <div class="rounded-full bg-blue-500 w-5 h-5 -ml-5 flex items-center justify-center text-white text-xs">+2</div>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-2 mt-2">
                                    <a href="/tasks/task/${task.id}/" class="text-blue-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="12" cy="12" r="2" />
                                            <path d="M22 12c-1.656 -3.422 -5.1 -6 -10 -6s-8.344 2.578 -10 6c1.656 3.422 5.1 6 10 6s8.344 -2.578 10 -6" />
                                        </svg>
                                    </a>
                                    <form method="post" action="/tasks/task/${task.id}/delete/">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <line x1="4" y1="7" x2="20" y2="7" />
                                                <line x1="10" y1="11" x2="10" y2="17" />
                                                <line x1="14" y1="11" x2="14" y2="17" />
                                                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                                                <path d="M9 7v-3h6v3" />
                                            </svg>
                                        </button>
                                    </form>
                                    <a href="/tasks/task/${task.id}/edit/" class="text-green-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="20" height="30" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M19 3l2 2l-14 14h-2v-2z" />
                                            <path d="M15 5l4 4" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>`;
                });

                $(container).html(html);

                // Add event listeners for the dropdown toggle
                $('.dropdown-toggle').off('click').on('click', function() {
                    $(this).next('.dropdown-menu').toggleClass('hidden');
                });

                // Hide the dropdown menu when clicking outside
                $(document).off('click').on('click', function(e) {
                    if (!$(e.target).closest('.dropdown-toggle, .dropdown-menu').length) {
                        $('.dropdown-menu').addClass('hidden');
                    }
                });
            }
        });
    }

    // Load tasks for each category
    loadTasks('in_progress', '#in_progress_tasks');
    loadTasks('completed', '#completed_tasks');
    loadTasks('overdue', '#overdue_tasks');
});
</script>
{% endblock %}

